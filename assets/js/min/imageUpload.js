var dropZone=document.getElementById("dropZone"),preImage=document.getElementById("preImage"),replaceText=document.getElementById("replaceText"),imageUpload=document.getElementById("imageUpload"),uploadForm=document.getElementById("uploadForm"),turnstileToken="",turnstileWidgetId=null,isLoggedIn=!1;function checkSession(){fetch("/api/checkSession").then((function(e){return e.json()})).then((function(e){isLoggedIn=e.loggedIn;var t=document.getElementById("account-section"),n=document.getElementById("createAccText"),o=document.getElementById("turnstile-container"),i=document.getElementById("username-display");e.loggedIn?(t&&(t.style.display="block"),i&&(i.textContent="@"+e.username),n&&(n.style.display="none"),o&&(o.style.display="none")):(t&&(t.style.display="none"),n&&(n.style.display="block"))})).catch((function(e){var t=document.getElementById("account-section"),n=document.getElementById("createAccText");t&&(t.style.display="none"),n&&(n.style.display="block")}))}function loadTurnstileScript(){if(window.turnstile||document.getElementById("turnstile-script"))setTimeout(initTurnstile,100);else{var e=document.createElement("script");e.id="turnstile-script",e.src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit",e.async=!0,e.onload=function(){setTimeout(initTurnstile,100)},document.head.appendChild(e)}}function initTurnstile(){var e=document.getElementById("turnstile-container");if(window.turnstile){if(e&&!isLoggedIn)try{turnstileWidgetId=turnstile.render("#turnstile-container",{sitekey:"0x4AAAAAACDFfOKm7uvwfqiR",theme:"dark",callback:window.turnstileCallback})}catch(e){console.error("Turnstile error:",e)}}else setTimeout(initTurnstile,500)}function showLinks(e,t){var n=document.getElementById("link-container"),o=document.getElementById("image-link-direct"),i=document.getElementById("copy-button-1");n&&(n.style.display="flex"),o&&(o.textContent=e),i&&(i.onclick=function(){copyText(e)})}function resetForm(){preImage.style.display="none",preImage.src="",dropZone.classList.remove("filed"),replaceText.style.display="none",imageUpload.value="",window.turnstile&&!isLoggedIn&&null!==turnstileWidgetId&&(turnstile.reset(turnstileWidgetId),turnstileToken="")}function copyText(e){navigator.clipboard.writeText(e).then((function(){notify("Copied to clipboard!","success")})).catch((function(){notify("Failed to copy","error")}))}window.turnstileCallback=function(e){turnstileToken=e},dropZone.addEventListener("dragover",(function(e){e.preventDefault(),e.stopPropagation(),dropZone.classList.add("hover")})),dropZone.addEventListener("dragleave",(function(e){e.preventDefault(),e.stopPropagation(),dropZone.classList.remove("hover")})),dropZone.addEventListener("drop",(function(e){e.preventDefault(),e.stopPropagation();var t=e.dataTransfer.files;t.length>0&&(imageUpload.files=t,imageUpload.dispatchEvent(new Event("change")))})),dropZone.addEventListener("click",(function(){imageUpload.click()})),imageUpload.addEventListener("change",(function(e){var t=e.target.files[0];if(t){if(!t.type.startsWith("image/"))return notify("Not an image!","error"),void(imageUpload.value="");if(!isLoggedIn){var n=document.getElementById("turnstile-container");n&&(n.style.display="block"),loadTurnstileScript()}var o=new FileReader;o.onload=function(e){preImage.src=e.target.result,preImage.style.display="block",dropZone.classList.add("filed"),dropZone.classList.remove("hover"),replaceText.style.cssText="display:inline-block; text-align:center; width:100%;"},o.readAsDataURL(t)}})),uploadForm.addEventListener("submit",(function(e){if(e.preventDefault(),imageUpload.files&&0!==imageUpload.files.length)if(isLoggedIn||turnstileToken){var t=new FormData;t.append("image",imageUpload.files[0]),turnstileToken&&t.append("token",turnstileToken);var n=uploadForm.querySelector('button[type="submit"]'),o=n.textContent;n.disabled=!0,n.textContent="Uploading...",fetch("/api/uploadImage",{method:"POST",body:t}).then((function(e){return e.json()})).then((function(e){"success"===e.status?(notify(e.message,"success"),console.log(e.path),showLinks(window.location.origin+e.path,e.fileID||"unknown"),resetForm()):notify(e.message||"Upload failed","error")})).catch((function(e){notify("An error occurred during upload","error")})).finally((function(){n.disabled=!1,n.textContent=o}))}else notify("Please complete the captcha!","error");else notify("Please select an image!","error")})),document.addEventListener("DOMContentLoaded",checkSession);